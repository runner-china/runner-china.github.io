---
author: runner
date: 2018-07-10 20:50+08:00
layout: post
title: "搭建私有CA与基于OpenSSL的双向身份认证"
description: ""
comments : true
categories:
- 技术
tags:
- OpenSSL
- 身份认证
- HTTPS
---


# 0x00 前言

一般Web应用由于用户数目广泛，都是采用单向身份认证的，只需要客户端验证服务端的身份。但如果是企业内部的应用对接，客户端数量有限，可能会要求对客户端也做身份验证，这时就需要一个双向认证方案。本文通过搭建私有CA，利用[OpenSSL](https://zh.wikipedia.org/wiki/OpenSSL)工具，实现服务端与客户端的双向身份认证。安全协议采用HTTPS，HTTPS除了能够进行身份认证以外，还能保证通信的保密性和完整性。

# 0x01 组建方案
组建方案如下图所示：  

- 整个方案包括一个私有CA、一个服务端、一个客户端，用于验证HTTPS双向身份认证的可行性。
- 服务端的系统环境为CentOS7，Web服务器采用Tomcat7。客户端的系统环境为Windows，浏览器采用Firefox、Chrome。
- 由私有CA负责生成所有的私钥、证书等文件，并通过线下安全途径分发到服务端和客户端。
- 其中，CA的私钥最为重要需加密保管，服务端持有CA证书、服务器私钥、服务器证书3个文件，客户端持有CA证书、客户端私钥、客户端证书3个文件。
- 客户端与服务端通过HTTPS安全协议进行双向身份认证、加密传输。另外，需要注意的是，HTTPS实现的是传输层的身份认证，不含应用层鉴权功能。

<!--more-->
![](/blog/images/18071001.png)

# 0x02 私有CA的设置

## 安装与配置OpenSSL

OpenSSL默认安装完后，另外需要创建以下几个文件：
touch /etc/pki/CA/index.txt       index文件用于记录已经签发的证书
touch /etc/pki/CA/serial
echo 00 > /etc/pki/CA/serial      serial文件用于存放证书的序列号，自动递增

因为，服务器证书请求文件的国家，省，市要和CA证书一致，这个在openssl.cnf默认配置中指定了。
修改openssl.cnf，调整为非强制一致。
vi /etc/pki/tls/openssl.cnf        
将下面的几个match 修改为 optional
# For the CA policy
[ policy_match ]
countryName             = match
stateOrProvinceName     = match
organizationName        = match


## 自签CA证书

1. 生成根证书私钥 cakey.pem
openssl genrsa  -des3 -out cakey.pem  2048 
这一步需要输入密码，密码用于加密私钥，使私钥非明文存于磁盘
2. 生成根证书签发申请文件 ca.csr
openssl req -new -key cakey.pem -out ca.csr -subj "/C=CN/O=CAorganization/CN=myCA"
3. 自签发根证书 cacert.pem
openssl x509 -req -days 3650 -sha256 -extensions v3_ca -signkey cakey.pem -in ca.csr -out  cacert.pem 

## 服务端的私钥与证书

## 客户端的私钥与证书

# 0x03 服务器端的设置

## 安装Java、Tomcat

## 把服务端私钥和证书制作成JKS文件

## 把信任根证书制作成JKS文件

## 配置Tomcat

## 安全措施

# 0x04 客户端的设置

## 修改客户端hosts文件
hosts中加入一行   192.168.1.10    myserver.test.com
其中，192.168.1.10是服务端的IP，根据实际情况填写。
注意：这里hosts文件作用是代替DNS域名解析，仅为测试使用。

## 客户端浏览器导入CA根证书

## 客户端浏览器导入自己的私钥和证书

# 0x05 双向身份验证与效果




**注：如需转载这篇文章请注明出处**  




